(()=>{"use strict";(()=>{const e=(e,t)=>{const o=e-.5+Math.random()*(t-e+1);return Math.round(o)};window.util={getRandomNumber:e,getRandomElement:e=>e[Math.floor(Math.random()*e.length)],getRandomArray:t=>{const o=t.slice();let n,r;for(let e=o.length-1;e>0;e--)n=Math.floor(Math.random()*(e+1)),r=o[e],o[e]=o[n],o[n]=r;return o.slice(e(0,o.length))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__filters"),n=e.querySelector("#address"),r=document.querySelector(".map");window.constant={adForm:e,MIN_Y:130,MAX_Y:630,MIN_X:0,MAX_X:1200,mapPin:t,mapFilter:o,inputAdress:n,map:r,MAP_PIN_WIDTH:65,MAP_PIN_HEIGHT:84}})(),(()=>{const e=(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,o?(n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(o)):(n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send())};window.backend={load:(t,o)=>{e(t,o)},save:(t,o,n)=>{e(t,o,n)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=window.constant.map,t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},o=o=>{const n=e.querySelector(".map__filters-container"),r=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0);if(r.querySelector(".popup__title").textContent=o.offer.title,r.querySelector(".popup__text--address").textContent=o.offer.address,r.querySelector(".popup__text--price").textContent=o.offer.price+"₽/ночь",r.querySelector(".popup__type").textContent=t[o.offer.type],r.querySelector(".popup__text--capacity").textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,r.querySelector(".popup__description").textContent=o.offer.description,r.querySelector(".popup__avatar").src=o.author.avatar,0===o.offer.photos.length)r.querySelector(".popup__photos").style.display="none";else{const e=r.querySelector(".popup__photos"),t=e.querySelector(".popup__photo"),n=o.offer.photos;e.innerHTML="";const a=document.createDocumentFragment();n.forEach((e=>{const o=t.cloneNode(!0);o.src=e,a.appendChild(o)})),e.appendChild(a)}if(0===o.offer.photos.length)r.querySelector(".popup__features").style.display="none";else{const e=r.querySelector(".popup__features"),t=e.querySelector(".popup__feature"),n=o.offer.features;e.innerHTML="";const a=document.createDocumentFragment();n.forEach((e=>{const o=t.cloneNode(!0);o.classList.add("popup__feature--"+e),a.appendChild(o)})),e.appendChild(a)}e.insertBefore(r,n)},n=()=>{const t=e.querySelector(".map__card");if(t){const o=t.querySelector(".popup__close");e.removeChild(t),o.removeEventListener("click",r),document.removeEventListener("keydown",a)}},r=()=>{n(),e.querySelector(".map__pin--active").classList.remove("map__pin--active")},a=t=>{"Escape"===t.key&&(t.preventDefault(),n(),e.querySelector(".map__pin--active").classList.remove("map__pin--active"))};window.card={create:o,open:t=>{n(),o(t),e.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",r),document.addEventListener("keydown",a)},close:n}})(),(()=>{const e=window.constant.mapFilter,t=e.querySelector("#housing-type"),o=e.querySelector("#housing-guests"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-price"),a=e.querySelector("#housing-features");window.filter=e=>{let s=[];return e.forEach((function(e){(e=>"any"===t.value||e.offer.type===t.value)(e)&&(e=>"any"===n.value||e.offer.rooms===Number(n.value))(e)&&(e=>"any"===o.value||e.offer.guests===Number(o.value))(e)&&(e=>"any"===r.value||("low"===r.value?e.offer.price<1e4:"middle"===r.value?e.offer.price>1e4&&e.offer.price<5e4:e.offer.price>5e4))(e)&&(e=>{const t=a.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.includes(t.value)}))})(e)&&s.push(e)})),s}})(),(()=>{const e=window.constant.map,t=window.card.open,o=window.card.close,n=window.constant.mapFilter,r=window.filter,a=window.debounce,s=o=>{const n=document.querySelector(".map__pins"),r=document.createDocumentFragment();let a=5<o.length?5:o.length;o.filter((e=>e.offer)).slice(0,a).forEach((o=>{r.appendChild((o=>{const n=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);return n.style.left=o.location.x-25+"px",n.style.top=o.location.y-70+"px",n.querySelector("img").src=o.author.avatar,n.querySelector("img").alt=o.offer.title,n.addEventListener("click",(()=>{let r=e.querySelector(".map__pin--active");r&&r.classList.remove("map__pin--active"),t(o),n.classList.add("map__pin--active")})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&(t(o),n.classList.add("map__pin--active"))})),n})(o))})),n.appendChild(r)},i=()=>{document.querySelectorAll(".map__pin").forEach((function(e){e.classList.contains("map__pin--main")||e.remove()}))},d=()=>{i(),s(r(l)),o()},c=a((()=>{d()}));n.addEventListener("change",c);let l=[];window.mark={add:s,delete:i,update:d,successHandler:e=>{l=e,s(e)},errorHandler:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=window.constant.MAP_PIN_WIDTH,t=window.constant.MAP_PIN_HEIGHT,o=window.constant.MIN_Y,n=window.constant.MAX_Y,r=window.constant.MIN_X,a=window.constant.MAX_X,s=window.constant.mapPin,i=window.constant.inputAdress;window.move={onMousedown:d=>{d.preventDefault();let c={x:d.clientX,y:d.clientY};const l=d=>{d.preventDefault();const l=c.x-d.clientX,u=c.y-d.clientY;c={x:d.clientX,y:d.clientY},s.offsetTop-u<o-t?s.style.top=o-t+"px":s.offsetTop-u>n-t?s.style.top=n-t+"px":s.style.top=s.offsetTop-u+"px",s.offsetLeft-l<r-Math.round(e/2)?s.style.left=r-Math.round(e/2)+"px":s.offsetLeft-l>a-Math.round(e/2)?s.style.left=a-Math.round(e/2)+"px":s.style.left=s.offsetLeft-l+"px",i.value=`${parseInt(s.style.left,10)+Math.round(e/2)}, ${parseInt(s.style.top,10)+t}`},u=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.addEventListener("mouseup",u)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",u)}}})(),(()=>{const e=window.constant.MAP_PIN_WIDTH,t=window.constant.MAP_PIN_HEIGHT,o=window.constant.mapPin,n=window.constant.adForm,r=window.constant.mapFilter,a=window.move.onMousedown,s=window.constant.inputAdress,i=window.backend.load,d=window.mark.successHandler,c=window.mark.errorHandler,l=o.offsetLeft,u=o.offsetTop,p=e=>{Array.from(e.children).forEach((e=>{e.setAttribute("disabled","disabled")}))},m=e=>{Array.from(e.children).forEach((e=>{e.removeAttribute("disabled","disabled")}))},y=()=>{document.querySelector(".map").classList.remove("map--faded"),document.querySelector(".ad-form").classList.remove("ad-form--disabled"),i(d,c),m(n),m(r),(()=>{const n=parseInt(o.style.left,10),r=parseInt(o.style.top,10);s.value=`${n+Math.round(e/2)}, ${r+t}`})(),o.removeEventListener("mousedown",v),o.removeEventListener("keydown",f),o.addEventListener("mousedown",a)},v=e=>{0===e.button&&y()},f=e=>{"Enter"===e.key&&y()};window.map={deactivate:()=>{document.querySelector(".map").classList.add("map--faded"),document.querySelector(".ad-form").classList.add("ad-form--disabled"),p(n),p(r),o.addEventListener("mousedown",v),o.addEventListener("keydown",f),o.style.left=l+"px",o.style.top=u+"px",(()=>{const t=parseInt(o.style.left,10),n=parseInt(o.style.top,10);s.value=`${t+Math.round(e/2)}, ${n+Math.round(e/2)}`})()},onMousedown:v,onEnterPress:f,inputAdress:s}})(),(()=>{const e=window.constant.mapPin,t=window.map.deactivate,o=window.map.onMousedown,n=window.map.onPinEnterPress;t(),e.addEventListener("mousedown",o),e.addEventListener("keydown",n)})(),(()=>{const e=["gif","jpg","jpeg","png"],t=window.constant.inputAdress,o=window.constant.adForm,n=o.querySelector("#room_number"),r=o.querySelector("#capacity"),a=o.querySelector("#title"),s=o.querySelector("#price"),i=o.querySelector("#type"),d=o.querySelector("#timein"),c=o.querySelector("#timeout"),l=o.querySelector("#images"),u=o.querySelector(".ad-form__field input[type=file]"),p=o.querySelector(".ad-form-header__preview img"),m=o.querySelector(".ad-form__photo"),y=()=>{"1"===n.value&&"1"!==r.value?n.setCustomValidity("1 комната только для 1 гостя"):"2"!==n.value||"3"!==r.value&&"0"!==r.value?"3"===n.value&&"0"===r.value?n.setCustomValidity("Для 3 или менее гостей"):"100"===n.value&&"0"!==r.value?n.setCustomValidity("Не для гостей"):n.setCustomValidity(""):n.setCustomValidity("Для 2 и менее гостей"),n.reportValidity()};r.addEventListener("change",y),n.addEventListener("change",y),a.setAttribute("required","required"),a.addEventListener("input",(()=>{let e=a.value.length;e<30?a.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?a.setCustomValidity("Удалите лишние "+(e-100)+" симв."):a.setCustomValidity(""),a.reportValidity()})),s.setAttribute("max","1000000"),s.setAttribute("required","required"),s.addEventListener("input",(()=>{s.value>1e6?s.setCustomValidity("Максимальная цена 1000000"):s.setCustomValidity(""),s.reportValidity()}));const v=()=>{"bungalow"===i.value&&s.value<0?(s.setCustomValidity("Для бунгало минимальная цена за ночь 0р"),s.setAttribute("placeholder","0"),s.setAttribute("min","0")):"flat"===i.value&&s.value<1e3?(s.setCustomValidity("Для квартиры минимальная цена за ночь 1000р"),s.setAttribute("placeholder","1000"),s.setAttribute("min","1000")):"house"===i.value&&s.value<5e3?(s.setCustomValidity("Для дома минимальная цена за ночь 5000р"),s.setAttribute("placeholder","5000"),s.setAttribute("min","5000")):"palace"===i.value&&s.value<1e4?(s.setCustomValidity("Для дворца минимальная цена за ночь 10000р"),s.setAttribute("placeholder","10000"),s.setAttribute("min","10000")):s.setCustomValidity(""),s.reportValidity()};s.addEventListener("change",v),i.addEventListener("change",v),t.setAttribute("readonly","readonly"),d.addEventListener("change",(()=>{c.value=d.value})),c.addEventListener("change",(()=>{d.value=c.value})),u.setAttribute("accept","image/*"),u.addEventListener("change",(()=>{const t=u.files[0],o=t.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{p.src=e.result})),e.readAsDataURL(t)}})),l.setAttribute("accept","image/*"),l.addEventListener("change",(()=>{const t=l.files[0],o=t.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img");m.innerHTML="",t.src=e.result,t.classList.add("ad-form__photo-preview"),m.append(t)})),e.readAsDataURL(t)}})),window.validate={avatarPreview:p,imagesPreview:m,defaultAvatarUrl:"img/muffin-grey.svg"}})(),(()=>{const e=window.constant.adForm,t=window.map.deactivate,o=window.backend.save,n=window.mark.delete,r=window.card.close,a=window.validate.avatarPreview,s=window.validate.imagesPreview,i=window.validate.defaultAvatarUrl,d=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),c=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),l=e=>{"Escape"===e.key&&(e.preventDefault(),d&&d.remove(),c&&c.remove())},u=()=>{c.remove(),document.removeEventListener("keydown",l),document.removeEventListener("click",u),c.querySelector(".error__button").removeEventListener("click",u)},p=()=>{d.remove(),document.removeEventListener("keydown",l),document.removeEventListener("click",p)},m=()=>{a.src=i,s.innerHTML="",e.reset(),n(),r(),t()},y=()=>{m(),document.body.insertAdjacentElement("afterbegin",d),document.addEventListener("keydown",l),document.addEventListener("click",p)},v=()=>{r(),document.querySelector("main").insertAdjacentElement("afterbegin",c),document.addEventListener("keydown",l),document.addEventListener("click",u),c.querySelector(".error__button").addEventListener("click",u)};e.addEventListener("submit",(t=>{t.preventDefault(),o(y,v,new FormData(e))})),e.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),m()}))})()})();